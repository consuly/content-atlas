name: Sync Frontend to Frontend Repository

on:
  push:
    branches: [ main ]
    paths:
      - 'frontend/**'
  workflow_dispatch:

jobs:
  sync-frontend:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout main repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Git
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'

    - name: Clone Frontend repository
      run: |
        git clone https://${{ secrets.FRONTEND_REPO_TOKEN }}@github.com/${{ secrets.FRONTEND_REPO_OWNER }}/content-atlas-frontend.git frontend-repo
        cd frontend-repo
        git checkout main || git checkout -b main
        cd ..

    - name: Sync frontend files
      run: |
        cd frontend-repo

        # Remove all files except .git
        find . -not -path './.git*' -delete

        # Copy frontend directory contents to root
        cp -r ../frontend/* ./

    - name: Create frontend README
      run: |
        cd frontend-repo
        printf '# Content Atlas Frontend\n\nReact frontend for Content Atlas - a data consolidation platform built with Refine.dev.\n\n## Features\n\n- Modern React admin interface\n- File upload and data mapping\n- Natural language database queries\n- Real-time import progress tracking\n- Responsive design with Ant Design\n\n## Quick Start\n\n1. Install dependencies:\n   ```bash\n   npm install\n   ```\n\n2. Set up environment variables:\n   ```bash\n   cp .env.example .env\n   # Edit .env to point to your API URL\n   ```\n\n3. Run development server:\n   ```bash\n   npm run dev\n   ```\n\n## Environment Variables\n\n- VITE_API_URL: URL of the Content Atlas API (default: http://localhost:8000)\n\n## Build for Production\n\n```bash\nnpm run build\n```\n\n## Deployment\n\nThis repository is automatically synced from the main Content Atlas monorepo.\nManual changes to this repository may be overwritten.\n\nThe frontend can be deployed to:\n- Vercel\n- Netlify\n- Railway\n- Any static hosting service\n' > README.md

    - name: Check for changes
      id: check_changes
      run: |
        cd frontend-repo
        if [[ -n $(git status --porcelain) ]]; then
          echo "changes=true" >> $GITHUB_OUTPUT
        else
          echo "changes=false" >> $GITHUB_OUTPUT
        fi

    - name: Commit and push changes
      if: steps.check_changes.outputs.changes == 'true'
      run: |
        cd frontend-repo
        git add .
        git commit -m "Sync from monorepo: ${GITHUB_SHA}"
        git push origin main
