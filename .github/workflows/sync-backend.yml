name: Sync Backend to API Repository

on:
  push:
    branches: [ main ]
    paths:
      - 'app/**'
      - 'docs/**'
      - 'tests/**'
      - 'requirements.txt'
      - 'Dockerfile'
      - 'railway.json'
      - '.env.example'
      - 'pytest.ini'
      - 'reset_dev_db.py'
      - 'create_admin_user.py'
      - 'add_file_hash_column.py'
      - 'AGENTS.md'
  workflow_dispatch:

jobs:
  sync-backend:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout main repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Git
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'

    - name: Clone API repository
      run: |
        git clone https://${{ secrets.API_REPO_TOKEN }}@github.com/${{ secrets.API_REPO_OWNER }}/content-atlas-api.git api-repo
        cd api-repo
        git checkout main || git checkout -b main
        cd ..

    - name: Sync backend files
      run: |
        cd api-repo

        # Remove all files except .git
        find . -not -path './.git*' -delete

        # Copy backend files from main repo
        cp -r ../app ./
        cp -r ../docs ./
        cp -r ../tests ./
        cp ../requirements.txt ./
        cp ../Dockerfile ./
        cp ../railway.json ./
        cp ../.env.example ./
        cp ../pytest.ini ./
        cp ../reset_dev_db.py ./
        cp ../create_admin_user.py ./
        cp ../add_file_hash_column.py ./
        cp ../AGENTS.md ./

        # Create API-specific README
        printf '# Content Atlas API\n\nFastAPI backend for Content Atlas - a data consolidation platform.\n\n## Features\n\n- Multi-format file processing (CSV, Excel, JSON, XML)\n- Dynamic PostgreSQL schema creation\n- Duplicate detection and prevention\n- Natural language database queries via LLM\n- RESTful API with automatic documentation\n\n## Quick Start\n\n1. Install dependencies:\n   ```bash\n   pip install -r requirements.txt\n   ```\n\n2. Set up environment variables (copy from .env.example)\n\n3. Run the application:\n   ```bash\n   uvicorn app.main:app --reload\n   ```\n\n## API Documentation\n\n- API: http://localhost:8000\n- Interactive Docs: http://localhost:8000/docs\n\n## Deployment\n\nThis repository is automatically synced from the main Content Atlas monorepo.\nManual changes to this repository may be overwritten.\n' > README.md

    - name: Check for changes
      id: check_changes
      run: |
        cd api-repo
        if [[ -n $(git status --porcelain) ]]; then
          echo "changes=true" >> $GITHUB_OUTPUT
        else
          echo "changes=false" >> $GITHUB_OUTPUT
        fi

    - name: Commit and push changes
      if: steps.check_changes.outputs.changes == 'true'
      run: |
        cd api-repo
        git add .
        git commit -m "Sync from monorepo: ${GITHUB_SHA}"
        git push origin main
